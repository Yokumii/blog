
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>YokumiのBlog</title>
        <link rel="icon" href="/blog/images/favicon.ico" type="image/x-icon">
        <link rel="shortcut icon" href="/blog/images/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/blog/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/blog/js/lib/math.js"></script>


<script src="/blog/js/lib/preview.js"></script>









<link rel="stylesheet" href="/blog/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/blog/atom.xml" title="YokumiのBlog" type="application/atom+xml">
</head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/blog/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/blog/">
            <span>YOKUMIのBLOG</span>
        </a>
        
        <a href="/blog/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/blog/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/blog/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/blog/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/blog/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;YOKUMIのBLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/blog/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/blog/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/blog/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/blog/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/blog/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>CMU Bomb Lab 个人题解</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/11/5
        </span>
        
        <span class="category">
            <a href="/blog/categories/CSAPP/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                CSAPP
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/blog/tags/CSAPP/" style="color: #00bcd4">
                    CSAPP
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/blog/tags/%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81/" style="color: #00a596">
                    汇编代码
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="一实验目的">一、实验目的</h2>
<p>1.理解C语言程序的机器级表示。</p>
<p>2.初步掌握GDB调试器的用法。</p>
<p>3.阅读C编译器生成的x86-64机器代码，理解不同控制结构生成的基本指令模式，过程的实现。</p>
<h2 id="二实验环境">二、实验环境</h2>
<ol type="1">
<li>作业服务器</li>
<li>MacOS终端工具</li>
<li>Linux</li>
<li>Objdump命令反汇编</li>
<li>GDB调试工具</li>
<li>积分榜</li>
</ol>
<h2 id="三实验内容">三、实验内容</h2>
<p>登录作业服务器，在home目录下可以找到Evil博士专门为你量身定制的一个bomb，当运行时，它会要求你输入一个字符串，如果正确，则进入下一关，继续要求你输入下一个字符串；否则，炸弹就会爆炸，输出一行提示信息并向计分服务器提交扣分信息。因此，本实验要求你必须通过反汇编和逆向工程对bomb执行文件进行分析，找到正确的字符串来解除这个的炸弹。</p>
<p>本实验通过要求使用课程所学知识拆除一个“binary
bombs”来增强对程序的机器级表示、汇编语言、调试器和逆向工程等方面原理与技能的掌握。
“binary
bombs”是一个Linux可执行程序，包含了5个阶段（或关卡）。炸弹运行的每个阶段要求你输入一个特定字符串，你的输入符合程序预期的输入，该阶段的炸弹就被拆除引信；否则炸弹“爆炸”，打印输出
“BOOM!!!”。炸弹的每个阶段考察了机器级程序语言的一个不同方面，难度逐级递增。</p>
<p>为完成二进制炸弹拆除任务，需要使用gdb调试器和objdump来反汇编bomb文件，可以单步跟踪调试每一阶段的机器代码，也可以阅读反汇编代码，从中理解每一汇编语言代码的行为或作用，进而设法推断拆除炸弹所需的目标字符串。</p>
<h2 id="四实验步骤及实验分析">四、实验步骤及实验分析</h2>
<h3 id="准备工作">准备工作</h3>
<ul>
<li>首先通过 <code>ls</code> 命令查看文件，找到炸弹文件包
<code>bomb. tar</code>；</li>
<li>然后通过命令 <code>tar -xvf bomb.tar</code> 解压得到三个文件；</li>
</ul>
<h3 id="第一阶段">第一阶段</h3>
<ul>
<li>使用 <code>gdb</code> 运行<code>bomb</code>；</li>
<li>设置断点在函数 <code>phase_1</code>
处，开始运行，输入测试字符串<code>12345</code>；</li>
<li>用<code>\disas</code> 显示<code>phase_1</code>
部分的汇编代码开始分析；</li>
</ul>
<p><img src="1.png" alt="phase_1汇编代码"></p>
<ul>
<li>观察到调用了一个 <code>strings_not_equal</code>
函数，根据函数名，其功能很可能是比较输入字符和正确字符是否匹配的函数；</li>
<li>在<code>strings_not_equal</code>
函数处设置断点，直接<code>continue</code>运行进入该函数；</li>
<li>显示<code>strings_not_equal</code> 的汇编代码开始分析；</li>
</ul>
<p><img src="2.png" alt="strings_not_equal 函数汇编代码"></p>
<p><strong>Note! <code>%rdi</code>
存放函数的第一个输入，<code>%rsi</code>
存放函数的第二个输入，<code>%eax</code> 存放函数的返回值。</strong></p>
<ul>
<li>观察到调用了 <code>string_length</code>
函数，根据函数名，其功能很可能是获取输入字符数量的函数；</li>
<li>在 <code>string_length</code>
函数处设置断点，直接<code>continue</code>运行进入该函数；</li>
<li>分析可得其先比较字符串长度，二者不相等则在 <code>%eax</code> 中存 1
返回；若相等，则比较具体内容，若不相等则在 <code>%eax</code> 中存 1
返回；</li>
<li>结合寄存器功能和汇编代码可以得到函数比较的字符串内容分别存放在
<code>%rdi</code> 和 <code>%rsi</code> 中，分别打印寄存器的值如下：</li>
</ul>
<p><img src="3.png" alt="字符串内容"></p>
<ul>
<li>得到 <code>%rdi</code> 存放的是我们输入的字符串， <code>%rsi</code>
是目标字符串。函数中，<code>%rsi</code> 的值被赋给 <code>%rbp</code>，
<code>%rbp</code> 和 <code>%rdi</code> 上的字符串进行比较。所以
<code>phase_1</code> 需要我们输入与其相同的字符串即可通过。</li>
</ul>
<h3 id="第二阶段">第二阶段</h3>
<ul>
<li>在 <code>phase_2</code> 入口处设置断点，运行程序，输入
<code>phase_1</code> 答案，进入阶段
2；同上操作得到汇编代码进行分析；</li>
</ul>
<p><img src="4.png" alt="第二阶段开始"></p>
<ul>
<li>观察发现其调用<code>read_six_numbers</code>函数，设置断点进入，显示该函数的汇编代码，观察到将地址<code>$0x402a31</code>存入
<code>%esi</code> 后调用 <code>scanf</code>
函数，打印该地址的值，验证了该函数的需要输入6个整数。也可以由下面的
<code>cmp</code> 语句得到，如果<code>scanf</code>
的返回值小于等于5会触发爆炸。</li>
</ul>
<p><img src="5.png" alt="第二阶段输入格式确定"></p>
<p><strong>Note! <code>%rsp</code>
存放堆栈指针，括号表示获取地址上的值。<code>%rbp</code>
存放的是栈的基址。</strong></p>
<ul>
<li>继续回到 <code>phase_2</code>，由 <code>cmpl</code>
语句可见第一个输入的整数(<code>%rsp</code>存的地址上的值)需要 &gt;=
1，将其存放到 <code>%eax</code> 上，并将其变为2倍后继续存在
<code>%eax</code>，再与输入的第二个整数比较，要求结果相等，否则触发爆炸。然后检查当前栈指针是否到达栈的基址<code>%rbp</code>，如果顺利到达则跳出，成功通过。</li>
<li>可以推测出 <code>phase_2</code>
是一种循环结构，依次比较每个输入整数是否符合是前一个输入的2倍，推出一个答案为<code>1 2 4 8 16 32</code>。</li>
</ul>
<h3 id="第三阶段">第三阶段</h3>
<ul>
<li>同上操作，此处不再赘述，进入<code>phase_3</code>并得到汇编代码如下：</li>
</ul>
<p><img src="6.png" alt="第三阶段汇编代码1"></p>
<p><img src="7.png" alt="第三阶段汇编代码2"></p>
<ul>
<li>第三阶段代码较为冗长，先通过打印 <code>scanf</code>
函数的调用值得到输入格式为两个整数和一个字符。</li>
</ul>
<p><img src="8.png" alt="第三阶段输入格式"></p>
<ul>
<li>分析在 <code>0x400fe4</code> 处的 <code>cmpl $0x7, 0x10(%rsp)</code>
指令以及下一条指令 <code>ja 0x4010ef</code>
，得出<code>0x10(%rsp)</code> 处的值，即输入的第一个整数（占
2<sup>4</sup> = 0x10 个字节） ≤ 7。</li>
<li><code>0x400ff3</code> 处的指令 <code>jmpq \*0x4027a0(,%rax,8)</code>
表示跳转到 <code>0x4027a0+输入的第一个整数 *8</code>
所存储的地址处，打印出所有可能的跳转地址如下：</li>
</ul>
<p><img src="9.png" alt="所有可能地址"></p>
<p><strong>Note！<code>*</code> 表示间接跳转，<code>0x4027a0</code>
是一个基地址（立即数），语句应跳转到计算得到的地址上存的地址值。</strong></p>
<ul>
<li>此时，再结合 <code>phase_3</code> 整体代码，进行拆分，可以推测其为
<code>switch</code> 分支结构，选择 <code>case 0</code>
进行分析。（每个case结构都基本相同）：</li>
</ul>
<p><img src="10.png" alt="case 0结构"></p>
<ul>
<li>分析可得，首先比较输入的第二个整数与<code>0x2d7（727）</code>，相等则跳至
<code>4010eb &lt;+318&gt;:  cmp 0xf(%rsp),%al</code>，将输入的字符与
<code>%al (0x77)</code>，对应 ASCII 码
<code>w</code>比较，相等则通过。</li>
</ul>
<p><strong>Note！<code>%al</code> 和 <code>%eax</code>
为同一个寄存器，<code>%al</code> 是 <code>%rax</code> 寄存器的最低 8
位。<code>%eax</code> 是低 32 位。</strong></p>
<ul>
<li>以此类推，得到所有可能答案如下：</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: center;"><strong>第一个整数</strong></th>
<th style="text-align: center;"><strong>字符</strong></th>
<th style="text-align: center;"><strong>第二个整数</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">w</td>
<td style="text-align: center;">727</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">u</td>
<td style="text-align: center;">786</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">g</td>
<td style="text-align: center;">63</td>
</tr>
<tr>
<td style="text-align: center;">3</td>
<td style="text-align: center;">f</td>
<td style="text-align: center;">363</td>
</tr>
<tr>
<td style="text-align: center;">4</td>
<td style="text-align: center;">s</td>
<td style="text-align: center;">117</td>
</tr>
<tr>
<td style="text-align: center;">5</td>
<td style="text-align: center;">d</td>
<td style="text-align: center;">602</td>
</tr>
<tr>
<td style="text-align: center;">6</td>
<td style="text-align: center;">q</td>
<td style="text-align: center;">818</td>
</tr>
<tr>
<td style="text-align: center;">7</td>
<td style="text-align: center;">e</td>
<td style="text-align: center;">197</td>
</tr>
</tbody>
</table>
<h3 id="第四阶段">第四阶段</h3>
<ul>
<li>同上操作，此处不再赘述，进入 phase_4 并得到汇编代码如下。</li>
</ul>
<p><img src="11.png" alt="第四阶段汇编代码"></p>
<ul>
<li>先通过打印 <code>scanf</code>
函数的调用值得到输入格式为两个整数。</li>
</ul>
<p><img src="12.png" alt="第四阶段输入格式"></p>
<ul>
<li>发现 <code>phase_4</code> 调用了
<code>func4</code>函数，在这之前，先检查了输入是否为2个整数，再将第二个输入的整数赋给
<code>%eax</code>，减2后和2比较大小，如果小于等于2则继续。得到第二个整数
&lt;= 4。</li>
<li>在进入函数之前，观察得到 <code>%esi</code>（第二个输入的整数）和
<code>%rdi (8)</code>作为参数被传入 <code>func4</code>。</li>
<li>进入函数，打印其汇编代码如下：</li>
</ul>
<p><img src="13.png" alt="func4汇编代码"></p>
<ul>
<li>大致观察即可发现其为递归函数，分析汇编指令画出大致流程图如下：</li>
</ul>
<p><img src="14.png" alt="个人绘制的大致流程图"></p>
<ul>
<li>分析得到递归函数如下：<code>func4(n, x) = x + func4(n – 1, x) + func4(n – 2, x), n &gt; 1；func4(1, x) = x, func4(0, x) = 0</code>。</li>
<li>如果第二个输入为2，那么可以推出<code>func4(8, 2) = 108</code>，再根据函数结束后中<code>cmp 0x4(%rsp),%eax</code>可以判断返回值需要和第一个输入相等，所以一个答案为<code>108 2</code>。</li>
</ul>
<p><img src="15.png" alt="递归树状图"></p>
<h3 id="第五阶段">第五阶段</h3>
<ul>
<li>同上操作，此处不再赘述，进入 <code>phase_5</code>
并得到汇编代码如下：</li>
</ul>
<p><img src="16.png" alt="第五阶段汇编代码"></p>
<ul>
<li>同样发现其调用 <code>strings_length</code>
函数，由第一阶段分析可知，输入的字符串长度应为6。并且函数尾部调用
<code>strings_not_equal</code>
函数，比较输入字符串（<code>%rdi</code>）和目标字符串（<code>%rsi</code>）是否相等。</li>
<li>由
<code>0x401204 &lt;+76&gt;: mov $0x40278f,%esi</code>语句可知目标字符串的地址，打印内容可得：</li>
</ul>
<p><img src="17.png" alt="目标字符串内容"></p>
<ul>
<li>再分析中间对字符串的操作部分。先将输入字符串存入 <code>%rbx</code>
中，然后通过指令 <code>movzbl (%rbx,%rax,1),%edx</code>
取出输入字符的第一位存到 <code>%edx</code> 中。</li>
</ul>
<p><strong>Note! <code>movzbl</code> 从源操作数读取一个 8
位值，并将其扩展到 32 位，填充高 24
位为零，然后存入目标寄存器。</strong></p>
<p><strong>Note!
<code>(%rbx, %rax, 1)</code>是内存地址的计算方式，表示从
<code>(%rbx + %rax * 1)</code> 地址处读取一个字节的数据。其中
<code>%rbx</code> 是基地址寄存器，<code>%rax</code>
是索引寄存器，1是偏移量。</strong></p>
<ul>
<li>对于取出的字符，执行
<code>and  $0xf,%edx</code>，分析可得其作用是将其低四位保留下来，其余位清零。</li>
<li>接着执行<code>movzbl 0x4027e0(%rdx),%edx</code>，表示从
<code>0x4027e0 + %rdx</code> 处取出 1 字节数据扩展后存储 到
<code>%edx</code> 中，然后将 <code>%dl</code> 中的数据存储在
<code>(%rbx + %rax \* 1)</code> 处；</li>
<li>上述操作重复 6 次直到 <code>%rax</code> 等于
6，即字符串操作完毕。</li>
<li>打印 <code>0x4027e0</code>上的内容：</li>
</ul>
<p><img src="18.png" alt="密钥内容"></p>
<ul>
<li><p>分析可得，该阶段是在 <code>0x4027e0</code> 处挑选第
<code>%rdx</code>
个字符，然后这些挑选出的字符组合成一个字符串，即目标字符串
<code>bruins</code>；</p></li>
<li><p>但是我们要进行的是解密操作，<code>bruins</code>
在密钥中对应的索引为
<code>13，6，3，4，8，7</code>，所以只需要输入的字符的低四位符合对应的索引即可，一个答案是
<code>MFCDHG</code> 。</p></li>
<li><p>简述一下<code>phase_6</code>和<code>secret_phase</code>，两者都涉及到对自定义结构体的操作，<code>phase_6</code>是对链表按照数据大小进行重排，而<code>secret_phase</code>是一个二叉搜索树。</p></li>
</ul>
<p><img src="19.png" alt="答案汇总"></p>
<p><img src="20.png" alt="通过截图"></p>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2023 - 2025 YokumiのBlog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Yokumi
        </div>
        
    </div>
</footer>

<script>
  var event = new Event('hexo-blog-decrypt');
  window.dispatchEvent(event);
</script>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/blog/js/main.js"></script>
    
    




    
</body>
</html>
